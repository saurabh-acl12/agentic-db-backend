<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI SQL Chatbot</title>
    <style>
      :root { --primary: #0b5cff; --bg: #f5f7fb; --card: #ffffff; --text: #1f2933; --muted: #6b7280; --border: #e5e7eb; --sidebar-width: 280px; }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); display: flex; }
      header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
      .brand { display: flex; align-items: center; gap: 8px; font-weight: 700; color: var(--primary); }
      .brand svg { height: 28px; width: 28px; }
      .actions { display: flex; gap: 8px; align-items: center; }
      button, .btn { border: 1px solid var(--border); background: var(--card); color: var(--text); padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
      button.primary, .btn.primary { background: var(--primary); color: #fff; border: none; }
      main { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05); }
      .chat-window { height: 70vh; display: flex; flex-direction: column; }
      .messages { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 12px; }
      .bubble { padding: 12px 14px; border-radius: 12px; max-width: 85%; white-space: pre-wrap; word-wrap: break-word; }
      .bubble.user { align-self: flex-end; background: #e0e7ff; }
      .bubble.assistant { align-self: flex-start; background: #f3f4f6; }
      .meta { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
      .input-row { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
      .input-row input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px; }
      .sidebar h3 { margin-top: 0; }
      pre { background: #0b1627; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
      .chips { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 12px; }
      .chip { background: #eef2ff; color: #4338ca; padding: 8px 10px; border-radius: 999px; cursor: pointer; font-size: 13px; border: 1px solid #e0e7ff; }
      .chip:hover { background: #e0e7ff; }
      .sql-block { margin-top: 8px; }
      .result { max-height: 280px; overflow: auto; }
      .empty { color: var(--muted); text-align: center; padding: 16px; }
      /* Sidebar styles */
      .sidebar-container {
        width: var(--sidebar-width);
        background: var(--card);
        border-right: 1px solid var(--border);
        height: 100vh;
        overflow-y: auto;
        position: fixed;
        left: 0;
        top: 0;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        transition: transform 0.3s ease;
      }

      .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
      }

      .sidebar-header h2 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--primary);
      }

      .session-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .session-item {
        padding: 10px 12px;
        margin: 5px 0;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .session-item:hover {
        background-color: #f0f4ff;
      }

      .session-item.active {
        background-color: #e6f0ff;
        font-weight: 500;
      }

      .session-time {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .toggle-sidebar {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 10px;
        color: var(--primary);
      }

      @media (max-width: 1024px) {
        .sidebar-container {
          transform: translateX(-100%);
          width: 80%;
          max-width: 300px;
        }
        
        .sidebar-container.visible {
          transform: translateX(0);
        }
        
        .main-content {
          margin-left: 0;
          width: 100%;
        }
        
        .toggle-sidebar {
          display: block;
        }
      }

      @media (max-width: 960px) { 
        main { 
          grid-template-columns: 1fr; 
          padding: 15px;
        } 
        .chat-window { 
          height: 60vh; 
        } 
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar-container" id="sidebar">
      <div class="sidebar-header">
        <h2>Chat Sessions</h2>
      </div>
      <button id="new-session-btn" class="btn primary" style="width: 100%; margin-bottom: 15px;">
        + New Session
      </button>
      <ul class="session-list" id="session-list">
        <!-- Sessions will be added here by JavaScript -->
      </ul>
    </div>

    <div class="main-content">
    <header>
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 7.5L12 4l8 3.5v4.5c0 4.5-3.4 6.9-8 8-4.6-1.1-8-3.5-8-8V7.5Z" stroke="#0b5cff" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M8 10.5 12 12l4-1.5" stroke="#0b5cff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        AI SQL Chatbot
      </div>
      <div class="actions">
        <span id="session-label" class="meta"></span>
        <button id="new-chat" class="btn">New chat</button>
      </div>
    </header>

    <main>
      <section class="card chat-window">
        <div class="meta">Chat about your database. Follow-ups use memory.</div>
        <div class="chips">
          <div class="chip" onclick="useExample('Show me all the clients')">Show me all the clients</div>
          <div class="chip" onclick="useExample('Total workload by month for 2024')">Total workload by month for 2024</div>
          <div class="chip" onclick="useExample('Which consultants worked on project ACME?')">Which consultants worked on project ACME?</div>
          <div class="chip" onclick="useExample('Average mission rating per client')">Average mission rating per client</div>
        </div>
        <div id="messages" class="messages"></div>
        <div class="input-row">
          <input id="message-input" type="text" placeholder="Ask a question about your data..." />
          <button id="send-btn" class="primary">Send</button>
        </div>
      </section>

      <section class="card sidebar">
        <h3>Generated SQL</h3>
        <div class="sql-block">
          <pre id="sql-query">Ask a question to see SQL</pre>
        </div>
        <h3>Latest result</h3>
        <div id="result-container" class="result empty">No results yet.</div>
      </section>
    </main>

    <script>
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      const sqlEl = document.getElementById("sql-query");
      const resultEl = document.getElementById("result-container");
      const sessionLabel = document.getElementById("session-label");
      const newChatBtn = document.getElementById("new-chat");
      const sidebar = document.getElementById("sidebar");
      const toggleSidebarBtn = document.createElement("button");
      toggleSidebarBtn.className = "toggle-sidebar";
      toggleSidebarBtn.innerHTML = "â˜°";
      toggleSidebarBtn.onclick = () => sidebar.classList.toggle("visible");
      document.querySelector(".brand").prepend(toggleSidebarBtn);
      
      // Session management
      const sessionList = document.getElementById("session-list");
      const newSessionBtn = document.getElementById("new-session-btn");

      let sessionId = localStorage.getItem("chatSessionId");
      let isSending = false;

      const setSessionLabel = () => {
        sessionLabel.textContent = sessionId ? `Session: ${sessionId.slice(0, 8)}` : "No session";
      };

      const ensureSession = async () => {
        if (sessionId) return sessionId;
        const res = await fetch("/chat/start", { method: "POST" });
        const data = await res.json();
        sessionId = data.session_id;
        localStorage.setItem("chatSessionId", sessionId);
        setSessionLabel();
        return sessionId;
      };

      const formatResult = (result) => {
        if (!result || result.length === 0) {
          resultEl.classList.add("empty");
          resultEl.innerHTML = "No results.";
          return;
        }
        resultEl.classList.remove("empty");
        if (Array.isArray(result)) {
          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");
          const headers = Object.keys(result[0]);
          const headerRow = document.createElement("tr");
          headers.forEach((h) => {
            const th = document.createElement("th");
            th.textContent = h;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          result.forEach((row) => {
            const tr = document.createElement("tr");
            headers.forEach((h) => {
              const td = document.createElement("td");
              td.textContent = row[h];
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          resultEl.innerHTML = "";
          resultEl.appendChild(table);
        } else {
          resultEl.textContent = JSON.stringify(result, null, 2);
        }
      };

      const renderMessages = (history) => {
        if (!history || history.length === 0) {
          messagesEl.innerHTML = `<div class="empty">Ask a question to begin.</div>`;
          return;
        }
        const sorted = [...history].sort(
          (a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0)
        );
        messagesEl.innerHTML = "";
        sorted.forEach((turn) => {
          const userBubble = document.createElement("div");
          userBubble.className = "bubble user";
          userBubble.innerHTML = `<div class="meta">${turn.created_at || ""}</div>${turn.question || ""}`;
          messagesEl.appendChild(userBubble);
          if (turn.sql) {
            const assistantBubble = document.createElement("div");
            assistantBubble.className = "bubble assistant";
            assistantBubble.innerHTML = `<div class="meta">SQL</div><code>${turn.sql}</code>`;
            messagesEl.appendChild(assistantBubble);
          }
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      };

      const loadHistory = async () => {
        await ensureSession();
        const res = await fetch(`/chat/${sessionId}/history?limit=50`);
        const data = await res.json();
        renderMessages(data.history || []);
      };

      const sendMessage = async () => {
        if (isSending) return;
        const message = inputEl.value.trim();
        if (!message) return;
        isSending = true;
        sendBtn.textContent = "Sending...";

        await ensureSession();

        try {
          const res = await fetch("/chat/message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId, message }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.detail || "Request failed");
          }
          sqlEl.textContent = data.sql || "No SQL generated.";
          formatResult(data.result);
          inputEl.value = "";
          await loadHistory();
        } catch (err) {
          alert(err.message || "Something went wrong");
        } finally {
          isSending = false;
          sendBtn.textContent = "Send";
        }
      };

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      newChatBtn.addEventListener("click", async () => {
        await createNewSession();
        messagesEl.innerHTML = `<div class="empty">Started a new chat.</div>`;
        sqlEl.textContent = "Ask a question to see SQL";
        resultEl.classList.add("empty");
        resultEl.textContent = "No results yet.";
        
        // Update the sessions list to show the new session as active
        await loadSessions();
      });

      function useExample(text) {
        inputEl.value = text;
        inputEl.focus();
      }

      // Session management functions
      async function createNewSession() {
        try {
          const res = await fetch("/chat/start", { method: "POST" });
          const data = await res.json();
          sessionId = data.session_id;
          localStorage.setItem("chatSessionId", sessionId);
          setSessionLabel();
          await loadSessions();
          await loadHistory();
          // Close sidebar on mobile after selecting a session
          if (window.innerWidth <= 1024) {
            sidebar.classList.remove("visible");
          }
          return sessionId;
        } catch (error) {
          console.error("Error creating new session:", error);
          alert("Failed to create a new session");
        }
      }

      async function loadSessions() {
        try {
          const res = await fetch("/chat/sessions");
          const data = await res.json();
          
          if (!data.sessions || data.sessions.length === 0) {
            sessionList.innerHTML = '<div style="padding: 10px; color: var(--muted);">No sessions yet</div>';
            return;
          }

          // Sort sessions by last_activity (newest first)
          const sortedSessions = [...data.sessions].sort((a, b) => 
            new Date(b.last_activity) - new Date(a.last_activity)
          );

          sessionList.innerHTML = sortedSessions.map(session => `
            <li class="session-item ${session.id === sessionId ? 'active' : ''}" 
                data-session-id="${session.id}">
              <span>${session.title || 'Untitled'}</span>
              <span class="session-time">${new Date(session.last_activity).toLocaleString()}</span>
            </li>
          `).join('');

          // Add click handlers to session items
          document.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', async () => {
              const clickedSessionId = item.getAttribute('data-session-id');
              if (clickedSessionId !== sessionId) {
                sessionId = clickedSessionId;
                localStorage.setItem("chatSessionId", sessionId);
                await loadHistory();
                setSessionLabel();
                
                // Update active state
                document.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Close sidebar on mobile after selecting a session
                if (window.innerWidth <= 1024) {
                  sidebar.classList.remove("visible");
                }
              }
            });
          });
        } catch (error) {
          console.error("Error loading sessions:", error);
          sessionList.innerHTML = '<div style="padding: 10px; color: var(--muted);">Error loading sessions</div>';
        }
      }

      // Initialize the app
      (async function init() {
        await ensureSession();
        setSessionLabel();
        await loadSessions();
        await loadHistory();
        
        // Set up new session button
        newSessionBtn.addEventListener('click', createNewSession);
        
        // Handle window resize for sidebar
        window.addEventListener('resize', () => {
          if (window.innerWidth > 1024) {
            sidebar.classList.add('visible');
          } else {
            sidebar.classList.remove('visible');
          }
        });
        
        // Initial sidebar state
        if (window.innerWidth > 1024) {
          sidebar.classList.add('visible');
        }
      })();
    </script>
  </body>
</html>
